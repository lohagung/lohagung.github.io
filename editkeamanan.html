<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>RT 09</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .notification-item {
            background-color: #f3f4f6;
        }
        .notification-item.clicked {
            color: #9ca3af;
        }
        .alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        .alert.show {
            display: block;
        }
        .notification-items li {
            font-size: xx-small;
            white-space: nowrap;
        }
        .data-item:hover, .data-item:focus, .data-item:active {
            background-color: #fbbf24;
        }
        .highlighted {
            background-color: yellow;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <div class="bg-teal-700 p-4 flex items-center justify-between relative">
        <div class="flex items-center">
            <i class="fas fa-bars text-white text-2xl"></i>
            <h1 class="text-white text-xl ml-4">RT 09</h1>
        </div>
        <div class="flex items-center space-x-4 relative">
            <div id="notification-menu" class="relative">
                <i id="notification-icon" class="fas fa-bell text-white text-xl cursor-pointer relative">
                    <span id="notification-count" class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full px-1 hidden">0</span>
                </i>
                <div id="notification-list" class="absolute right-0 mt-8 w-64 bg-white shadow-lg rounded-lg hidden overflow-y-auto max-h-96 md:max-h-64">
                    <ul id="notification-items" class="p-2 notification-items">
                        <!-- Notification items will be dynamically inserted here -->
                    </ul>
                </div>
            </div>
            <i id="search-icon" class="fas fa-search text-white text-xl cursor-pointer"></i>
        </div>
        <div id="search-bar" class="absolute inset-0 bg-teal-700 p-4 flex items-center justify-center hidden">
            <input id="search-input" type="text" placeholder="Search by name or block" class="w-full p-2 rounded">
            <i id="close-search" class="fas fa-times text-white text-2xl ml-4 cursor-pointer"></i>
        </div>
    </div>
    <!-- Data List -->
    <div class="container mx-auto p-4">
        <h1 id="report-title" class="text-2xl font-bold mb-4 text-center uppercase">LAPORAN DENDA RONDA 2025</h1>
        <div class="flex items-center justify-between mb-4">
            <select id="sheet-select" class="w-full p-2 border border-gray-300 rounded mt-1" onchange="getDatas()">
                <option value="Januari">Januari</option>
                <option value="Februari">Februari</option>
                <option value="Maret">Maret</option>
                <option value="April">April</option>
                <option value="Mei">Mei</option>
                <option value="Juni">Juni</option>
                <option value="Juli">Juli</option>
                <option value="Agustus">Agustus</option>
                <option value="September">September</option>
                <option value="Oktober">Oktober</option>
                <option value="November">November</option>
                <option value="Desember">Desember</option>
            </select>
            <i id="detail-icon" class="fas fa-eye text-teal-700 text-xl cursor-pointer ml-4" onclick="toggleDetails()"></i>
        </div>
        <div id="data-list" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Data List items will be dynamically inserted here -->
        </div>
    </div>
    <!-- Footer -->
    <footer class="bg-teal-700 text-white py-4">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <p>Â© 2025 Youshe. All rights reserved.</p>
                <div class="flex space-x-4">
                    <a class="text-white" href="#"><i class="fab fa-facebook-f"></i></a>
                    <a class="text-white" href="#"><i class="fab fa-twitter"></i></a>
                    <a class="text-white" href="#"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </footer>
    <!-- Alert -->
    <div id="alert" class="alert">
        <p id="alert-message"></p>
    </div>
    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzfdo3CVpQY501W56AZVHAa-ui3Uek-q3sZiww84Yagb7V7MoYpvi-uyW1oT9_jAzJQFQ/exec";
        let notifications = JSON.parse(localStorage.getItem('notifications')) || [];
        let showDetails = false;

        async function getDatas() {
            const sheet = document.getElementById("sheet-select").value;
            document.getElementById("report-title").innerText = `LAPORAN DENDA RONDA ${sheet.toUpperCase()}`;
            const response = await fetch(`${scriptURL}?action=get-data&sheet=${sheet}`);
            const result = await response.json();
            if (result.success) {
                const dataList = document.getElementById("data-list");
                dataList.innerHTML = "";
                result.data.forEach((data, index) => {
                    const blokImage = data.blok.toLowerCase().replace(/[\s.]/g, '');
                    const imageUrl = `/file/${blokImage}.jpg`;
                    const fallbackImageUrl = '/file/no-profil.jpeg';
                    const jumlahFormatted = data.jumlah == 0 ? '<span class="text-green-500"><i class="fas fa-check"></i> Lunas</span>' : `<span class="text-red-500">Rp ${parseInt(data.jumlah).toLocaleString('id-ID')}</span>`;
                    if (data.nama || showDetails) {
                        dataList.innerHTML += `
                            <div id="row-${data.id}" class="data-item flex justify-between items-center p-4 bg-white shadow rounded cursor-pointer" onclick="openEditPopup('${data.id}', '${data.nama}', '${data.blok}', '${data.tunggakan}', '${data.ronda1}', '${data.ronda2}', '${data.ronda3}', '${data.ronda4}', '${data.bulanan}', '${data.jumlah}', '${data.bayar}')">
                                <div class="flex items-center">
                                    <img src="${imageUrl}" alt="Profile picture of ${data.nama} from block ${data.blok}" onerror="this.onerror=null;this.src='${fallbackImageUrl}';" class="w-12 h-12 rounded-full mr-4">
                                    <div>
                                        <p class="text-lg font-semibold">${data.nama}</p>
                                        <p class="text-sm text-gray-600">${data.blok}</p>
                                    </div>
                                </div>
                                <p class="text-lg font-semibold">${jumlahFormatted}</p>
                            </div>`;
                    }
                });
            } else {
                showAlert("Gagal memuat data!");
            }
        }

        async function saveData() {
            const id = document.getElementById("id").value;
            const nama = document.getElementById("nama").value;
            const blok = document.getElementById("blok").value;
            const tunggakan = document.getElementById("tunggakan") ? document.getElementById("tunggakan").value : "";
            const ronda1 = document.getElementById("ronda1") ? document.getElementById("ronda1").value : "";
            const ronda2 = document.getElementById("ronda2") ? document.getElementById("ronda2").value : "";
            const ronda3 = document.getElementById("ronda3") ? document.getElementById("ronda3").value : "";
            const ronda4 = document.getElementById("ronda4") ? document.getElementById("ronda4").value : "";
            const bulanan = document.getElementById("bulanan") ? document.getElementById("bulanan").value : "";
            const jumlah = document.getElementById("jumlah") ? document.getElementById("jumlah").value : "";
            const bayar = document.getElementById("bayar") ? document.getElementById("bayar").value : "";
            const sheet = document.getElementById("sheet-select").value;
            let action = id ? "update" : "insert";
            const response = await fetch(
                `${scriptURL}?action=${action}&id=${id}&nama=${nama}&blok=${blok}&tunggakan=${tunggakan}&ronda1=${ronda1}&ronda2=${ronda2}&ronda3=${ronda3}&ronda4=${ronda4}&bulanan=${bulanan}&jumlah=${jumlah}&bayar=${bayar}&sheet=${sheet}`
            );
            const result = await response.json();
            showAlert(result.message);
            if (result.success) {
                if (action === "update") {
                }
                if (bayar) {
                    addNotification(`${nama} membayar ${bayar} ${new Date().toLocaleString()}`, id);
                }
                closePopup();
                getDatas();
            }
        }

        function calculateJumlah() {
            const tunggakan = parseFloat(document.getElementById("tunggakan").value) || 0;
            const ronda1 = parseFloat(document.getElementById("ronda1").value) || 0;
            const ronda2 = parseFloat(document.getElementById("ronda2").value) || 0;
            const ronda3 = parseFloat(document.getElementById("ronda3").value) || 0;
            const ronda4 = parseFloat(document.getElementById("ronda4").value) || 0;
            const bulanan = parseFloat(document.getElementById("bulanan").value) || 0;
            const bayar = parseFloat(document.getElementById("bayar").value) || 0;
            const jumlah = tunggakan + ronda1 + ronda2 + ronda3 + ronda4 + bulanan - bayar;
            document.getElementById("jumlah").value = jumlah;
        }

        function openEditPopup(id, nama, blok, tunggakan, ronda1, ronda2, ronda3, ronda4, bulanan, jumlah, bayar) {
            document.getElementById("id").value = id;
            document.getElementById("form-title").innerText = "Edit Data";
            document.getElementById("submit-btn").innerText = "Update Data";
            document.getElementById("form-content").innerHTML = `
                <div class="mb-4">
                    <label for="nama" class="block text-gray-700">Nama Data</label>
                    <input type="text" id="nama" class="w-full p-2 border border-gray-300 rounded mt-1" value="${nama}">
                </div>
                <div class="mb-4">
                    <label for="blok" class="block text-gray-700">Blok</label>
                    <input type="text" id="blok" class="w-full p-2 border border-gray-300 rounded mt-1 bg-yellow-200" value="${blok}" readonly>
                </div>
                <div class="mb-4">
                    <label for="tunggakan" class="block text-gray-700">Tunggakan</label>
                    <input type="number" id="tunggakan" class="w-full p-2 border border-gray-300 rounded mt-1" value="${tunggakan}" oninput="calculateJumlah()">
                </div>
                <div class="mb-4">
                    <label for="ronda1" class="block text-gray-700">Ronda 1</label>
                    <input type="number" id="ronda1" class="w-full p-2 border border-gray-300 rounded mt-1" value="${ronda1}" oninput="calculateJumlah()">
                </div>
                <div class="mb-4">
                    <label for="ronda2" class="block text-gray-700">Ronda 2</label>
                    <input type="number" id="ronda2" class="w-full p-2 border border-gray-300 rounded mt-1" value="${ronda2}" oninput="calculateJumlah()">
                </div>
                <div class="mb-4">
                    <label for="ronda3" class="block text-gray-700">Ronda 3</label>
                    <input type="number" id="ronda3" class="w-full p-2 border border-gray-300 rounded mt-1" value="${ronda3}" oninput="calculateJumlah()">
                </div>
                <div class="mb-4">
                    <label for="ronda4" class="block text-gray-700">Ronda 4</label>
                    <input type="number" id="ronda4" class="w-full p-2 border border-gray-300 rounded mt-1" value="${ronda4}" oninput="calculateJumlah()">
                </div>
                <div class="mb-4">
                    <label for="bulanan" class="block text-gray-700">Bulanan</label>
                    <input type="number" id="bulanan" class="w-full p-2 border border-gray-300 rounded mt-1" value="${bulanan}" oninput="calculateJumlah()">
                </div>
                <div class="mb-4">
                    <label for="jumlah" class="block text-gray-700">Jumlah</label>
                    <input type="number" id="jumlah" class="w-full p-2 border border-gray-300 rounded mt-1 bg-yellow-200" value="${jumlah}" readonly>
                </div>
                <div class="mb-4">
                    <label for="bayar" class="block text-gray-700">Bayar</label>
                    <input type="number" id="bayar" class="w-full p-2 border border-gray-300 rounded mt-1" value="${bayar}" oninput="calculateJumlah()">
                </div>
            `;
            document.getElementById("popup-form").classList.remove("hidden");
        }

        function closePopup() {
            document.getElementById("popup-form").classList.add("hidden");
        }

        function addNotification(message, id) {
            const notificationList = document.getElementById("notification-items");
            const notificationCount = document.getElementById("notification-count");
            notifications.unshift({ message, id, clicked: false });
            localStorage.setItem('notifications', JSON.stringify(notifications));
            notificationCount.innerText = notifications.filter(n => !n.clicked).length;
            notificationCount.classList.remove("hidden");
            renderNotifications();
        }

        function renderNotifications() {
            const notificationList = document.getElementById("notification-items");
            notificationList.innerHTML = "";
            notifications.forEach((notification, index) => {
                const listItem = document.createElement("li");
                listItem.className = `p-2 border-b border-gray-200 notification-item ${notification.clicked ? 'clicked' : ''}`;
                listItem.innerText = notification.message;
                listItem.onclick = () => {
                    document.getElementById(`row-${notification.id}`).scrollIntoView({ behavior: 'smooth' });
                    document.getElementById(`row-${notification.id}`).classList.add('highlighted');
                    setTimeout(() => {
                        document.getElementById(`row-${notification.id}`).classList.remove('highlighted');
                    }, 3000);
                    notification.clicked = true;
                    localStorage.setItem('notifications', JSON.stringify(notifications));
                    renderNotifications();
                    document.getElementById("notification-count").innerText = notifications.filter(n => !n.clicked).length;
                };
                notificationList.appendChild(listItem);
            });
        }

        function showAlert(message) {
            const alertBox = document.getElementById("alert");
            const alertMessage = document.getElementById("alert-message");
            alertMessage.innerText = message;
            alertBox.classList.add("show");
            setTimeout(() => {
                alertBox.classList.remove("show");
            }, 3000);
        }

        function toggleDetails() {
            showDetails = !showDetails;
            const detailIcon = document.getElementById("detail-icon");
            detailIcon.classList.toggle('fa-eye', !showDetails);
            detailIcon.classList.toggle('fa-eye-slash', showDetails);
            getDatas();
        }

        document.getElementById("notification-icon").addEventListener("click", () => {
            
            const notificationList = document.getElementById("notification-list");
            notificationList.classList.toggle("hidden");
        });

        document.getElementById("search-icon").addEventListener("click", () => {
            document.getElementById("search-bar").classList.remove("hidden");
        });

        document.getElementById("close-search").addEventListener("click", () => {
            document.getElementById("search-bar").classList.add("hidden");
        });

        document.getElementById("search-input").addEventListener("input", (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const dataList = document.getElementById("data-list");
            dataList.innerHTML = "";
            result.data.forEach((data) => {
                const name = data.nama.toLowerCase();
                const block = data.blok.toLowerCase();
                const blokImage = data.blok.toLowerCase().replace(/[\s.]/g, '');
                const imageUrl = `/file/${blokImage}.jpg`;
                const fallbackImageUrl = '/file/no-profil.jpeg';
                const jumlahFormatted = data.jumlah == 0 ? '<span class="text-green-500"><i class="fas fa-check"></i> Lunas</span>' : `<span class="text-red-500">Rp ${parseInt(data.jumlah).toLocaleString('id-ID')}</span>`;
                if (name.includes(searchTerm) || block.includes(searchTerm)) {
                    dataList.innerHTML += `
                        <div id="row-${data.id}" class="data-item flex justify-between items-center p-2 bg-white shadow rounded cursor-pointer" onclick="openEditPopup('${data.id}', '${data.nama}', '${data.blok}', '${data.tunggakan}', '${data.ronda1}', '${data.ronda2}', '${data.ronda3}', '${data.ronda4}', '${data.bulanan}', '${data.jumlah}', '${data.bayar}')">
                            <div class="flex items-center">
                                <img src="${imageUrl}" alt="Profile picture of ${data.nama} from block ${data.blok}" onerror="this.onerror=null;this.src='${fallbackImageUrl}';" class="w-12 h-12 rounded-full mr-4">
                                <div>
                                    <p class="text-lg font-semibold">${data.nama}</p>
                                    <p class="text-sm text-gray-600">${data.blok}</p>
                                </div>
                            </div>
                            <p class="text-lg font-semibold">${jumlahFormatted}</p>
                        </div>`;
                }
            });
        });

        window.onload = () => {
            getDatas();
            renderNotifications();
        };

        window.addEventListener("click", (event) => {
            const notificationList = document.getElementById("notification-list");
            if (!notificationList.contains(event.target) && !document.getElementById("notification-icon").contains(event.target)) {
                notificationList.classList.add("hidden");
            }
        });
    </script>
</body>
</html>