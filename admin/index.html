<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Warga - Final (Responsive Popup)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5; --primary-dark: #4338ca; --secondary: #64748b;
            --bg-body: #f1f5f9; --bg-card: #ffffff; --text-main: #0f172a; --text-muted: #64748b;
            --danger: #ef4444; --danger-light: #fef2f2; --border: #e2e8f0;
            --success: #22c55e; --success-light: #dcfce7;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; padding-bottom: 80px; }

        header { background: var(--bg-card); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 20; }
        
        .brand { font-weight: 600; font-size: 1.2rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .brand-logo { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid var(--bg-body); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .header-actions button { background: transparent; border: 1px solid var(--border); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted); }
        .header-actions button:hover { background: #f8fafc; color: var(--text-main); }

        main { flex: 1; overflow-y: auto; padding: 1.5rem; }

        #login-view { height: 100%; display: flex; justify-content: center; align-items: center; padding: 1rem; }
        .login-card { background: var(--bg-card); padding: 2.5rem; border-radius: var(--radius); box-shadow: var(--shadow); width: 100%; max-width: 400px; text-align: center; }
        .input-group { margin-bottom: 1.25rem; text-align: left; }
        .input-group label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .input-field { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 0.95rem; background-color: #fff; color: #333;}
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .input-field:read-only { background-color: #f1f5f9; color: #64748b; cursor: not-allowed; border-color: var(--border); }
        .btn-login { width: 100%; padding: 0.85rem; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 500; cursor: pointer; }
        .btn-login:hover { background: var(--primary-dark); }

        #dashboard-view { display: none; }
        .search-container { margin-bottom: 1.5rem; position: sticky; top: 0; z-index: 10; background: var(--bg-body); padding-bottom: 5px; }
        .search-input { width: 100%; padding: 1rem 1.5rem; border: none; border-radius: 50px; background: var(--bg-card); box-shadow: var(--shadow); font-size: 1rem; padding-left: 3.5rem; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'%3E%3C/path%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 1.2rem center; background-size: 1.2rem; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
        .stat-card { background: var(--bg-card); padding: 1.25rem; border-radius: var(--radius); box-shadow: var(--shadow); border-left: 5px solid var(--primary); }
        .stat-card.tunggakan { border-left-color: var(--danger); }
        .stat-title { font-size: 0.85rem; color: var(--secondary); font-weight: 500; margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--text-main); }

        /* Resident Card Grid (Pembayaran) */
        .card-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 0.8rem; 
            padding-bottom: 2rem; 
        }
        
        .warga-card { 
            background: var(--bg-card); 
            border-radius: var(--radius); 
            padding: 0rem 1.5rem 0rem 0rem; 
            display: flex; 
            align-items: center; 
            gap: 1rem; 
            box-shadow: var(--shadow); 
            transition: transform 0.2s; 
            border: 1px solid transparent; 
            height: auto;
        }
        .warga-card:hover { transform: translateY(-2px); border-color: var(--primary); }
        
        .avatar { 
            width: 60px; 
            height: 60px; 
            border-radius: 0.8rem 0 0 0.8rem; 
            padding: 0; 
            object-fit: cover; 
            border: none; 
            flex-shrink: 0; 
            background-color: #e2e8f0; 
        }
        .info { flex: 1; min-width: 0; }
        .info-name { font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .info-blok { font-size: 0.85rem; color: var(--secondary); font-weight: 500; display: flex; align-items: center; gap: 0.25rem; }
        
        /* Badges */
        .badge { padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .kurang-badge { background: var(--danger-light); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .kurang-badge:hover { background: var(--danger); color: white; }
        .lunas-badge { background: var(--success-light); color: var(--success); border: 1px solid rgba(34, 197, 94, 0.2); }
        .lunas-badge:hover { filter: brightness(0.95); }

        /* Rekap Styles */
        .rekap-list { background: var(--bg-card); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
        .rekap-item { display: flex; justify-content: space-between; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); align-items: center; }
        .rekap-item:last-child { border-bottom: none; }
        .rekap-month { font-weight: 600; color: var(--text-main); }
        .rekap-total { font-weight: 700; color: var(--primary); font-size: 1.1rem; }

        /* Riwayat Styles */
        .riwayat-list { display: flex; flex-direction: column; gap: 1rem; }
        .riwayat-item { background: var(--bg-card); padding: 1rem; border-radius: var(--radius); border-left: 4px solid var(--primary); box-shadow: var(--shadow); }
        .riwayat-date { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem; }
        .riwayat-msg { font-size: 0.95rem; color: var(--text-main); line-height: 1.4; }

        /* --- MODAL RESPONSIVE UPDATE --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.active { opacity: 1; }
        
        .modal { 
            background: var(--bg-card); 
            width: 95%; /* Update Mobile Width */
            max-width: 500px; /* Sedikit lebih sempit agar lega */
            height: 85vh; /* FIX: Batas tinggi modal agar tidak lewat layar */
            border-radius: 20px; 
            padding: 0; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
            display: flex; /* FIX: Flexbox layout */
            flex-direction: column; 
            overflow: hidden; /* FIX: Sembunyikan overflow di kontainer utama */
            transform: scale(0.9); 
            transition: transform 0.3s; 
        }
        
        .modal-overlay.active .modal { transform: scale(1); }
        
        .modal-header-bg { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            padding: 2rem 2rem 1rem 2rem; 
            color: white; 
            text-align: center; 
            border-radius: 20px 20px 0 0; 
            flex-shrink: 0; /* FIX: Jangan mengecil header */
        }
        .modal-profile-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.3); object-fit: cover; background: #fff; margin-bottom: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .modal-profile-name { font-size: 1.2rem; font-weight: 600; margin-bottom: 0.2rem; }
        .modal-profile-blok { font-size: 0.9rem; opacity: 0.9; background: rgba(255,255,255,0.2); display: inline-block; padding: 2px 10px; border-radius: 12px; }

        .modal-body { 
            padding: 1.5rem 2rem; 
            flex: 1; /* FIX: Ambil sisa ruang */
            overflow-y: auto; /* FIX: Aktifkan scroll vertikal */
            -webkit-overflow-scrolling: touch; /* FIX: Scroll halus di iOS */
            padding-bottom: 3rem; /* FIX: Extra padding di bawah agar konten tidak tertutup tombol */
        }

        .form-section-title { font-size: 0.8rem; color: var(--secondary); text-transform: uppercase; letter-spacing: 1px; margin: 1.5rem 0 0.5rem 0; font-weight: 600; border-left: 3px solid var(--primary); padding-left: 8px; }
        
        .month-row { display: flex; align-items: center; gap: 1rem; margin-bottom: 0.6rem; background: #fff; padding: 0.6rem; border-radius: 8px; border: 1px solid var(--border); transition: 0.2s; flex-wrap: nowrap; /* FIX: Jangan wrap baris bulan */}
        }
        .month-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); flex-shrink: 0; }
        .month-label { width: 80px; /* Update: Kurangi sedikit label */ font-size: 0.85rem; font-weight: 500; color: var(--text-main); flex-shrink: 0;}
        .month-input { 
            flex: 1; /* FIX: Ambil sisa lebar */
            padding: 0.5rem; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            text-align: right; 
            font-family: inherit; 
            font-size: 0.9rem; 
            transition: 0.2s;
            width: 100%; /* FIX: Pastikan input lebar penuh */
            min-width: 0;
        }
        .month-input:disabled { background-color: #f1f5f9; color: #64748b; }
        
        .month-row.active-month { border-color: var(--primary); background: rgba(79, 70, 229, 0.03); box-shadow: 0 2px 4px rgba(79, 70, 229, 0.05); }
        .month-row.active-month .month-label { color: var(--primary); font-weight: 600; }
        .month-row.active-month .month-checkbox { transform: scale(1.1); }

        .modal-actions { 
            margin-top: 0; /* FIX: Hapus margin top agar menempel di bawah konten scroll */
            padding: 1rem 2rem 1.5rem; /* Update padding */
            display: flex; 
            gap: 1rem; 
            background: var(--bg-card); /* FIX: Background agar konten di atasnya transparan */
            border-top: 1px solid var(--border); /* FIX: Garis pemisah */
            flex-shrink: 0; /* FIX: Jangan mengecil tombol */
        }

        .btn { flex: 1; padding: 0.85rem; border-radius: 10px; font-weight: 500; cursor: pointer; border: none; font-size: 0.95rem; }
        .btn-cancel { background: #f1f5f9; color: var(--text-muted); }
        .btn-save { background: var(--success); color: white; box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.3); }
        .btn-save:hover { background: #16a34a; }

        .note-2025 { padding: 0.75rem; background: #fff; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; color: var(--text-main); }
        .note-2025 span { font-weight: 700; color: var(--danger); }

        /* BOTTOM NAV */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); display: none; justify-content: space-around; padding: 0.8rem 0; z-index: 50; border-top: 1px solid var(--border); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary); font-size: 0.75rem; cursor: pointer; transition: 0.2s; flex: 1; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 4px; stroke: currentColor; stroke-width: 2; fill: none; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-item:hover { background-color: #f8fafc; }
        
        .hidden { display: none !important; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast-container { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); z-index: 300; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: #1e293b; color: white; padding: 12px 24px; border-radius: 50px; text-align: center; font-size: 0.9rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Views */
        .view-section { display: none; }
        .view-section.active { display: block; }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div></div>
    <div id="toast-container" class="toast-container"></div>

    <header id="main-header" class="hidden">
        <div class="brand">
            <img src="https://avatars.githubusercontent.com/u/61934361?v=4" class="brand-logo" alt="Logo">
            <span id="header-title">Manajemen Warga</span>
        </div>
        <div class="header-actions">
            <button onclick="handleLogout()">Keluar</button>
        </div>
    </header>

    <section id="login-view">
        <div class="login-card">
            <h2 style="margin-bottom: 0.5rem;">Login Admin</h2>
            <p style="margin-bottom: 2rem; color: var(--secondary); font-size: 0.9rem;">Masuk untuk mengelola data warga</p>
            
            <div class="input-group hidden">
                <label>URL Web App</label>
                <input type="url" id="app-url" class="input-field" value="https://script.google.com/macros/s/AKfycbwopjwy5tR4Q1q3q8oHOYZ83VKaDGekoM8hULbX-5jb460XCFREvv9cDZRVb50voHmaOw/exec" readonly>
            </div>
            
            <div class="input-group">
                <label>Nama Sheet</label>
                <input type="text" id="sheet-name" class="input-field" value="Jimpitan" placeholder="Contoh: 2026">
            </div>

            <div class="input-group">
                <label>Password Sheet (API Token)</label>
                <input type="password" id="api-token" class="input-field" placeholder="Masukkan Password Sheet">
            </div>
            
            <button class="btn-login" onclick="doLogin()">Masuk Dashboard</button>
        </div>
    </section>

    <main>
        <!-- VIEW 1: PEMBAYARAN -->
        <section id="view-pembayaran" class="view-section active">
            <div class="search-container">
                <input type="text" id="search-box" class="search-input" placeholder="Cari Blok atau Nama..." onkeyup="filterCards()">
            </div>

            <!-- Kartu Ringkasan Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Pemasukan</div>
                    <div class="stat-value" id="stat-pemasukan">Rp 0</div>
                </div>
                <div class="stat-card tunggakan">
                    <div class="stat-title">Tunggakan</div>
                    <div class="stat-value" id="stat-tunggakan" style="color: var(--danger);">Rp 0</div>
                </div>
            </div>

            <div id="card-container" class="card-grid"></div>
            <div id="empty-state" class="hidden" style="text-align: center; margin-top: 3rem; color: var(--secondary);"><p>Data tidak ditemukan.</p></div>
        </section>

        <!-- VIEW 2: REKAP -->
        <section id="view-rekap" class="view-section">
            <h2 style="margin-bottom: 1.5rem;">Rekapitulasi Bulanan</h2>
            <div class="rekap-list" id="rekap-container">
                <!-- List rekap akan dirender di sini -->
            </div>
        </section>

        <!-- VIEW 3: RIWAYAT -->
        <section id="view-riwayat" class="view-section">
            <h2 style="margin-bottom: 1.5rem;">Riwayat Pembayaran (<span id="riwayat-sheet-name"></span>)</h2>
            <div id="riwayat-container" class="riwayat-list">
                <!-- List riwayat akan dirender di sini -->
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="main-nav" style="display:none;">
        <div class="nav-item active" onclick="switchTab('pembayaran', this)">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span>Pembayaran</span>
        </div>
        <div class="nav-item" onclick="switchTab('rekap', this)">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10h.01M9 17h.01M9 17l.01.01M12 12l-3.5-6m11.5 6l-1 1m-14.5 6l3.5-6m4.5 6l1 1"></path></svg>
            <span>Rekap</span>
        </div>
        <div class="nav-item" onclick="switchTab('riwayat', this)">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>Riwayat</span>
        </div>
    </nav>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-bg">
                <img id="modal-avatar" src="" class="modal-profile-img" alt="Profile">
                <div class="modal-profile-name" id="modal-nama">Nama Warga</div>
                <div class="modal-profile-blok" id="modal-blok">Blok A1</div>
            </div>
            
            <div class="modal-body">
                <form id="edit-form" onsubmit="event.preventDefault(); saveData();">
                    
                    <div id="general-fields" style="margin-bottom: 1rem;"></div>

                    <div class="form-section-title">Status Pembayaran Bulanan</div>
                    <div id="monthly-fields"></div>

                </form>
                
                <!-- Tombol dikeluarkan dari form agar tetap di bawah scroll -->
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal()">Batal</button>
                    <button type="button" class="btn btn-save" onclick="document.getElementById('edit-form').requestSubmit()">Bayar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DEFAULT_IMG = "https://avatars.githubusercontent.com/u/61934361?v=4"; 
        const MONTHS = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const FORMULA_COLS = ["Total", "Sudah_Bayar", "Kurang", "Bulan_Aktif", "Timestamp", "Foto", "ID", "Created", "Email", "Telp"]; 
        let APP_CONFIG = { url: '', token: '', sheet: '' };
        let STATE = { data: [], headers: [], currentEdit: null };

        // --- INIT & AUTH ---
        window.addEventListener('DOMContentLoaded', () => {
            const stored = JSON.parse(localStorage.getItem('gas_dashboard_config'));
            if (stored) {
                APP_CONFIG = stored;
                document.getElementById('app-url').value = stored.url || '';
                document.getElementById('api-token').value = stored.token || '';
                document.getElementById('sheet-name').value = stored.sheet || '';
                if(stored.token) doLogin(true);
            }
        });

        async function doLogin(silent = false) {
            APP_CONFIG.url = document.getElementById('app-url').value.trim();
            APP_CONFIG.token = document.getElementById('api-token').value.trim();
            APP_CONFIG.sheet = document.getElementById('sheet-name').value.trim();

            if (!APP_CONFIG.url || !APP_CONFIG.token || !APP_CONFIG.sheet) return showToast("Mohon isi data login lengkap");

            localStorage.setItem('gas_dashboard_config', JSON.stringify(APP_CONFIG));
            toggleLoading(true);
            try {
                await fetchData();
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-nav').style.display = 'flex';
                
                const headerTitle = document.getElementById('header-title');
                if(headerTitle) headerTitle.innerText = APP_CONFIG.sheet;
                document.getElementById('riwayat-sheet-name').innerText = APP_CONFIG.sheet;

                if (!silent) showToast("Login Berhasil");
            } catch (e) {
                console.error(e);
                showToast("Error Login: " + e.message);
            } finally { toggleLoading(false); }
        }

        function handleLogout() { localStorage.removeItem('gas_dashboard_config'); location.reload(); }

        // --- DATA FETCHING & SAVING ---
        async function fetchData() {
            const url = new URL(APP_CONFIG.url);
            url.searchParams.append('token', APP_CONFIG.token);
            url.searchParams.append('sheet', APP_CONFIG.sheet);
            url.searchParams.append('action', 'get-data');
            
            const res = await fetch(url.toString());
            const json = await res.json();
            if (!json.success) throw new Error(json.message || "Gagal mengambil data");
            
            STATE.data = json.data;
            STATE.headers = json.data.length > 0 ? Object.keys(json.data[0]) : [];
            
            renderCards(STATE.data);
            updateSummaryCards(); 
            renderRekap(); 
            
            const currentTab = document.querySelector('.view-section.active').id;
            if(currentTab === 'view-riwayat') {
                fetchRiwayat();
            }
        }

        async function saveData() {
            const params = { Blok: STATE.currentEdit['Blok'] };
            let totalPembayaran = 0;

            STATE.headers.forEach(h => {
                if (!FORMULA_COLS.includes(h) && h !== 'Blok' && !MONTHS.includes(h)) {
                    if (h !== '2025') {
                        const input = document.getElementById(`field-${h}`);
                        if (input) params[h] = input.value;
                    }
                }
            });

            MONTHS.forEach(m => {
                const input = document.getElementById(`month-input-${m}`);
                if (input) {
                    const val = parseFloat(input.value) || 0;
                    params[m] = val;
                    totalPembayaran += val;
                }
            });

            const namaWarga = document.getElementById('modal-nama').innerText;
            const tanggalHariIni = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const namaSheet = APP_CONFIG.sheet;
            const pesanLog = `${namaWarga} melakukan pembayaran ${namaSheet} sebesar ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalPembayaran)}`;

            params['sheet_log'] = 'Riwayat';     
            params['Tanggal'] = tanggalHariIni; 
            params['Pesan'] = pesanLog;         

            toggleLoading(true);
            try {
                const url = new URL(APP_CONFIG.url);
                url.searchParams.append('token', APP_CONFIG.token);
                url.searchParams.append('sheet', APP_CONFIG.sheet);
                url.searchParams.append('action', 'update');
                
                Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));

                const res = await fetch(url.toString());
                const json = await res.json();
                if (!json.success) throw new Error(json.message);
                
                showToast("‚úÖ Pembayaran Berhasil!");
                closeModal();
                fetchData();
            } catch (e) {
                showToast("‚ùå Gagal simpan: " + e.message);
            } finally { toggleLoading(false); }
        }

        // --- LOGIC REKAP & RIWAYAT ---

        function renderRekap() {
            const container = document.getElementById('rekap-container');
            container.innerHTML = '';
            
            const totals = {};
            MONTHS.forEach(m => totals[m] = 0);

            STATE.data.forEach(row => {
                MONTHS.forEach(m => {
                    totals[m] += parseFloat(row[m]) || 0;
                });
            });

            MONTHS.forEach(m => {
                const val = totals[m];
                const div = document.createElement('div');
                div.className = 'rekap-item';
                div.innerHTML = `
                    <div class="rekap-month">${m}</div>
                    <div class="rekap-total">${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(val)}</div>
                `;
                container.appendChild(div);
            });
        }

        async function fetchRiwayat() {
            const container = document.getElementById('riwayat-container');
            container.innerHTML = '<div style="text-align:center; padding:2rem;"><div class="spinner" style="margin:0 auto;"></div><p style="margin-top:10px;">Memuat...</p></div>';

            try {
                const url = new URL(APP_CONFIG.url);
                url.searchParams.append('token', APP_CONFIG.token);
                url.searchParams.append('sheet', 'Riwayat'); 
                url.searchParams.append('action', 'get-data');
                
                const res = await fetch(url.toString());
                const json = await res.json();

                if (!json.success) {
                    container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--danger);"><p>Gagal memuat Riwayat.<br>Cek password sheet "Riwayat" di Code.gs.<br>Error: ${json.message}</p></div>`;
                    return;
                }

                const data = json.data;
                if (data.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--secondary);"><p>Belum ada riwayat.</p></div>`;
                    return;
                }

                const sheetName = APP_CONFIG.sheet;
                const filteredData = data.filter(row => {
                    return row.Pesan && row.Pesan.includes(sheetName);
                }).reverse();

                container.innerHTML = '';
                filteredData.forEach(row => {
                    let dateDisplay = row.Tanggal || row.Timestamp || "-";
                    if (dateDisplay instanceof Date) {
                         dateDisplay = dateDisplay.toLocaleDateString('id-ID');
                    }

                    const div = document.createElement('div');
                    div.className = 'riwayat-item';
                    div.innerHTML = `
                        <div class="riwayat-date">${dateDisplay}</div>
                        <div class="riwayat-msg">${row.Pesan}</div>
                    `;
                    container.appendChild(div);
                });

            } catch (e) {
                container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--danger);"><p>Error: ${e.message}</p></div>`;
            }
        }

        // --- CORE LOGIC: SETTINGS (INDEX & PRICE) ---
        function getSettings() {
            let index = 12; 
            let price = 0;
            STATE.data.forEach(row => {
                const val = row['Bulan_Aktif'];
                if (val !== undefined && val !== '' && val !== null) {
                    const numVal = parseFloat(val);
                    if (numVal >= 1 && numVal <= 12) index = numVal;
                    if (numVal > price) price = numVal;
                }
            });
            return { index, price };
        }

        // --- NAVIGATION ---
        function switchTab(tabName, el) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            el.classList.add('active');

            const views = document.querySelectorAll('.view-section');
            views.forEach(v => v.classList.remove('active'));

            if (tabName === 'pembayaran') {
                document.getElementById('view-pembayaran').classList.add('active');
            } else if (tabName === 'rekap') {
                document.getElementById('view-rekap').classList.add('active');
                renderRekap();
            } else if (tabName === 'riwayat') {
                document.getElementById('view-riwayat').classList.add('active');
                fetchRiwayat();
            }
        }

        // --- RENDER CARDS (TAB PEMBAYARAN) ---
        function renderCards(data) {
            const container = document.getElementById('card-container');
            container.innerHTML = '';
            if (!data || data.length === 0) return document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');

            const idxBlok = findIdx(['blok', 'block', 'no']);
            const idxKurang = findIdx(['kurang', 'sisa', 'deficit']);
            const idxNama = findIdx(['nama', 'pemilik', 'name']);
            const idxImg = findIdx(['foto', 'gambar', 'image', 'url', 'pic']);

            data.forEach((row, i) => {
                const nama = getVal(row, idxNama) || "";
                if (!nama || nama.trim() === "" || nama.toLowerCase() === '-') return;

                const blok = getVal(row, idxBlok) || "-";
                const kurang = parseFloat(getVal(row, idxKurang)) || 0;
                const imgUrl = getVal(row, idxImg);
                
                const avatarSrc = (imgUrl && imgUrl.startsWith('http')) ? imgUrl : DEFAULT_IMG;

                let badgeHTML = '';
                if (kurang <= 0) {
                    badgeHTML = `<div class="badge lunas-badge">‚úÖ Lunas</div>`;
                } else {
                    const fmtKurang = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(kurang);
                    badgeHTML = `<div class="badge kurang-badge" onclick="openEdit('${blok}')">${fmtKurang}</div>`;
                }

                const div = document.createElement('div');
                div.className = 'warga-card';
                div.innerHTML = `
                    <img src="${avatarSrc}" class="avatar" onerror="this.src='${DEFAULT_IMG}'">
                    <div class="info">
                        <div class="info-name" title="${nama}">${nama}</div>
                        <div class="info-blok">üìç ${blok}</div>
                    </div>
                    ${badgeHTML}
                `;
                container.appendChild(div);
            });
        }

        function updateSummaryCards() {
            let totalSudahBayar = 0;
            let totalKurang = 0;
            const dataToCount = STATE.data.slice(0, -1); 

            if (dataToCount.length > 0) {
                const headerKeys = STATE.headers;
                const idxBayar = headerKeys.findIndex(h => h.toLowerCase().includes('sudah_bayar'));
                const idxKurang = headerKeys.findIndex(h => h.toLowerCase().includes('kurang'));

                dataToCount.forEach(row => {
                    if (idxBayar !== -1) totalSudahBayar += parseFloat(row[headerKeys[idxBayar]]) || 0;
                    if (idxKurang !== -1) totalKurang += parseFloat(row[headerKeys[idxKurang]]) || 0;
                });
            }

            const fmtBayar = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalSudahBayar);
            const fmtTunggakan = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalKurang);

            document.getElementById('stat-pemasukan').innerText = fmtBayar;
            document.getElementById('stat-tunggakan').innerText = fmtTunggakan;
        }

        // --- MODAL & LOGIC ---
        function openEdit(blokId) {
            const row = STATE.data.find(r => r['Blok'] == blokId);
            if (!row) return;
            STATE.currentEdit = row;

            const idxNama = findIdx(['nama', 'pemilik', 'name']);
            const idxImg = findIdx(['foto', 'gambar', 'image', 'url', 'pic']);
            const nama = getVal(row, idxNama) || "-";
            const imgUrl = getVal(row, idxImg);
            const avatarSrc = (imgUrl && imgUrl.startsWith('http')) ? imgUrl : DEFAULT_IMG;

            document.getElementById('modal-nama').innerText = nama;
            document.getElementById('modal-blok').innerText = blokId;
            document.getElementById('modal-avatar').src = avatarSrc;
            document.getElementById('modal-avatar').onerror = function() { this.src = DEFAULT_IMG; };

            const generalContainer = document.getElementById('general-fields');
            const monthlyContainer = document.getElementById('monthly-fields');
            generalContainer.innerHTML = '';
            monthlyContainer.innerHTML = '';

            const settings = getSettings();
            const activeMonthLimit = settings.index; 
            const globalPrice = settings.price;     

            STATE.headers.forEach(h => {
                if (MONTHS.includes(h) || FORMULA_COLS.includes(h)) return; 
                if (h === 'Blok' || h === 'Nama' || h === 'nama' || h === 'Foto') return;

                if (h === '2025') {
                    const val = row[h] || 0;
                    const fmtVal = new Intl.NumberFormat('id-ID').format(val);
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `
                        <label class="form-label">${h}</label>
                        <div class="note-2025">
                            Catatan: ${h} tunggakan <span>${fmtVal}</span>
                        </div>
                    `;
                    generalContainer.appendChild(div);
                    return; 
                }

                const val = row[h] !== undefined ? row[h] : '';
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `
                    <label class="form-label">${h}</label>
                    <input type="text" id="field-${h}" class="form-input" value="${val}">
                `;
                generalContainer.appendChild(div);
            });

            MONTHS.forEach((month, index) => {
                if (index >= activeMonthLimit) return;

                const monthVal = parseFloat(row[month]) || 0;
                const isChecked = (monthVal === globalPrice);

                const div = document.createElement('div');
                div.className = `month-row ${isChecked ? 'active-month' : ''}`;
                const inputDisabled = isChecked ? 'disabled' : '';
                
                div.innerHTML = `
                    <input type="checkbox" id="check-${month}" class="month-checkbox" 
                        onchange="toggleMonthMode('${month}', this)" ${isChecked ? 'checked' : ''}>
                    <label class="month-label">${month}</label>
                    <input type="number" id="month-input-${month}" class="month-input" value="${monthVal}" 
                        oninput="handleManualInput('${month}', this)" ${inputDisabled}>
                `;
                monthlyContainer.appendChild(div);
            });

            const overlay = document.getElementById('edit-modal');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
        }

        function toggleMonthMode(month, checkbox) {
            const input = document.getElementById(`month-input-${month}`);
            const rowDiv = checkbox.closest('.month-row');
            const globalPrice = getSettings().price;

            if (checkbox.checked) {
                input.value = globalPrice;
                input.disabled = true;
                rowDiv.classList.add('active-month');
            } else {
                input.value = 0;
                input.disabled = false;
                rowDiv.classList.remove('active-month');
                input.focus();
            }
        }

        function handleManualInput(month, input) {
            const rowDiv = input.closest('.month-row');
            const checkbox = document.getElementById(`check-${month}`);
            if (input.disabled) return;

            const globalPrice = getSettings().price;
            const currentVal = parseFloat(input.value) || 0;

            if (currentVal === globalPrice) {
                checkbox.checked = true;
                input.disabled = true;
                rowDiv.classList.add('active-month');
            } else {
                checkbox.checked = false;
                input.disabled = false;
                rowDiv.classList.remove('active-month');
            }
        }

        function closeModal() {
            const overlay = document.getElementById('edit-modal');
            overlay.classList.remove('active');
            setTimeout(() => overlay.style.display = 'none', 300);
        }

        function filterCards() {
            const term = document.getElementById('search-box').value.toLowerCase();
            const filtered = STATE.data.filter(row => Object.values(row).some(val => String(val).toLowerCase().includes(term)));
            renderCards(filtered);
        }

        // --- UTILS ---
        function findIdx(keys) { return STATE.headers.findIndex(h => keys.some(k => h.toLowerCase().includes(k))); }
        function getVal(row, idx) { return idx !== -1 ? row[STATE.headers[idx]] : ''; }
        function toggleLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function showToast(msg) { 
            const el = document.createElement('div'); el.className = 'toast'; el.innerText = msg;
            const container = document.getElementById('toast-container');
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(20px)'; setTimeout(() => el.remove(), 300); }, 3000); 
        }
    </script>
</body>
</html>
