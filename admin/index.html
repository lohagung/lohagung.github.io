<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Warga LA6 & Kavling</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://la6.my.id/admin/style.css">

</head>
<body>

    <!-- SVG Icons Definitions -->
    <div style="display:none;">
        <svg id="icon-lock" viewBox="0 0 24 24"><path d="M12 17a2 2 0 100-4 2 2 0 000 4zm6-9h-1V6a5 5 0 00-10 0v2H6a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V10a2 2 0 00-2-2zM9 6a3 3 0 016 0v2H9V6z"/></svg>
        <svg id="icon-unlock" viewBox="0 0 24 24"><path d="M12 17a2 2 0 100-4 2 2 0 000 4zm6-9h-1V6a5 5 0 00-10 0v1H4v10a2 2 0 002 2h12a2 2 0 002-2V8h-2V7zM7 6a3 3 0 016 0v2H7V6zm11 11H6V9h12v8z"/></svg>
    </div>

    <div id="loading-overlay"><div class="spinner"></div></div>
    <div id="toast-container" class="toast-container"></div>

    <header id="main-header" class="hidden">
        <div class="brand">
            <img src="https://avatars.githubusercontent.com/u/61934361?v=4" class="brand-logo" alt="Logo">
            <span id="header-title">Manajemen Warga</span>
        </div>
    </header>

    <section id="login-view">
        <div class="login-card">
            <h2 style="margin-bottom: 0.5rem;">Login Admin</h2>
            <p style="margin-bottom: 2rem; color: var(--secondary); font-size: 0.9rem;">Masuk untuk mengelola data warga</p>
            
            <div class="input-group hidden">
                <label>URL Web App</label>
                <input type="url" id="app-url" class="input-field" value="https://script.google.com/macros/s/AKfycbwopjwy5tR4Q1q3q8oHOYZ83VKaDGekoM8hULbX-5jb460XCFREvv9cDZRVb50voHmaOw/exec" readonly>
            </div>
            
            <!-- PERUBAHAN: Select List untuk Login -->
            <div class="input-group">
                <label>Pengurus</label>
                <select id="sheet-name" class="input-field">
                    <option value="Ketua">Ketua</option>
                    <option value="Sekretaris">Sekretaris</option>
                    <option value="Bendahara">Bendahara</option>
                    <option value="Jimpitan">Jimpitan</option>
                    <option value="Sosial">Sosial</option>
                    <option value="Keamanan">Keamanan</option>
                    <option value="Pembangunan">Pembangunan</option>
                </select>
            </div>

            <div class="input-group">
                <label>Password</label>
                <input type="password" id="api-token" class="input-field" placeholder="Masukkan Password">
            </div>
            
            <button class="btn-login" onclick="doLogin()">Masuk Dashboard</button>
        </div>
    </section>

    <!-- PERUBAHAN: Sembunyikan main content secara default agar tertutup login screen -->
    <main id="main-content" style="display: none;">
        
        <!-- VIEW 1: PEMBAYARAN -->
        <section id="view-pembayaran" class="view-section active">
            <div class="search-container">
                <input type="text" id="search-box" class="search-input" placeholder="Cari Blok atau Nama..." onkeyup="filterCards()">
            </div>

            <!-- Stats Grid telah dipindahkan ke tab Rekap -->

            <div id="card-container" class="card-grid"></div>
            <div id="empty-state" class="hidden" style="text-align: center; margin-top: 3rem; color: var(--secondary);"><p>Data tidak ditemukan.</p></div>
        </section>

        <!-- VIEW 2: REKAP -->
        <section id="view-rekap" class="view-section">
            <h2 style="margin-bottom: 1.5rem;">Rekapitulasi Bulanan</h2>
            
            <!-- Stats Grid dipindahkan ke sini -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Uang Masuk 2026</div>
                    <div class="stat-value" id="stat-pemasukan">Rp 0</div>
                </div>
                <div class="stat-card tunggakan">
                    <div class="stat-title">Tunggakan</div>
                    <div class="stat-value" id="stat-tunggakan" style="color: var(--danger);">Rp 0</div>
                </div>
            </div>

            <div class="rekap-list" id="rekap-container"></div>
        </section>

        <!-- VIEW 3: RIWAYAT -->
        <section id="view-riwayat" class="view-section">
            <h2 style="margin-bottom: 1.5rem;">Riwayat Pembayaran (<span id="riwayat-sheet-name"></span>)</h2>
            <div id="riwayat-container" class="riwayat-list">
                <div style="text-align: center; padding: 2rem; color: var(--secondary);">
                    <p>Klik tab Riwayat untuk memuat data...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="main-nav" style="display:none;">
        <div class="nav-item active" onclick="switchTab('pembayaran', this)">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span>Pembayaran</span>
        </div>
        <div class="nav-item" onclick="switchTab('rekap', this)">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10h.01M9 17h.01M9 17l.01.01M12 12l-3.5-6m11.5 6l-1 1m-14.5 6l3.5-6m4.5 6l-1 1m-14.5 6l3.5-6m4.5 6l-1 1m-14.5 6l1 1"></path></svg>
            <span>Rekap</span>
        </div>
        <div class="nav-item" onclick="switchTab('riwayat', this)">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>Riwayat</span>
        </div>
        <div class="nav-item" onclick="openSettingsModal()">
            <svg viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317l.426-5.355a1.99 1.99 0 012.827-1.764l3.975.424a4.5 4.5 0 00-6.373-3.006l4.91 2.535zM17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
            <svg viewBox="0 0 24 24" style="position:absolute;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            <span>Pengaturan</span>
        </div>
    </nav>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header-bg">
                <button class="btn-close-edit" onclick="closeModal('edit-modal')">&times;</button>
                <img id="modal-avatar" src="" class="modal-profile-img" alt="Profile">
                <div class="modal-profile-name" id="modal-nama">Nama Warga</div>
                <div class="modal-profile-blok" id="modal-blok">Blok A1</div>
            </div>
            
            <div class="modal-body">
                <form id="edit-form" onsubmit="event.preventDefault(); saveData();">
                    <div id="general-fields" style="margin-bottom: 1rem; display: none;"></div>
                    
                    <div class="form-section-title">
                        <span>Pembayaran</span>
                        <span id="btn-kurang-modal" class="kurang-text-link" onclick="autoFillKurang()">Rp 0</span>
                    </div>
                    
                    <div id="monthly-fields"></div>
                </form>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-save" onclick="document.getElementById('edit-form').requestSubmit()">Bayar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal modal-settings">
            <div class="modal-header-simple">
                <div class="modal-title">Pengaturan Sistem</div>
                <button class="btn-close-icon" onclick="closeModal('settings-modal')">&times;</button>
            </div>
            
            <div class="settings-body">
                <div class="settings-buttons-row">
                    <button class="btn-share" onclick="shareSheet()">
                        <span>ðŸ”—</span> Bagikan
                    </button>
                    <button class="btn-logout" onclick="handleLogout()">
                        <span>ðŸšª</span> Keluar Akun
                    </button>
                </div>

                <div class="form-section-title" style="margin-top: 2rem;">Ganti Password Sheet</div>
                <form id="settings-form" onsubmit="event.preventDefault(); updateTokenAction();">
                    <input type="hidden" id="set-sheet-target" value="">
                    <div class="input-group">
                        <label>Password Lama</label>
                        <input type="password" id="old-token" class="input-field" placeholder="Masukkan password saat ini">
                    </div>
                    <div class="input-group">
                        <label>Password Baru</label>
                        <input type="password" id="new-token" class="input-field" placeholder="Masukkan password baru">
                    </div>
                    
                    <button type="submit" class="btn-update-pass">Update Password</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DEFAULT_IMG = "https://avatars.githubusercontent.com/u/61934361?v=4"; 
        const MONTHS = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        const FORMULA_COLS = ["Total", "Sudah_Bayar", "Kurang", "Bulan_Aktif", "Timestamp", "Foto", "ID", "Created", "Email", "Telp"]; 
        const MULTI_SHEETS = ["Kas", "Sampah", "Konsumsi", "Arisan"];
        
        // Indeks kolom yang dilindungi (F, J, L, N, P, R, T, V, X, Z, AB) -> (5, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27)
        const PROTECTED_INDICES = [5, 9, 11, 13, 15, 17, 19, 21, 23, 25, 27];

        // Pemetaan Absen Khusus Keamanan
        const ABSEN_MAP = {
            "Januari": 5, "Februari": 9, "Maret": 11, "April": 13, "Mei": 15,
            "Juni": 17, "Juli": 19, "Agustus": 21, "September": 23, "Oktober": 25, "November": 27
        };
        
        let APP_CONFIG = { url: '', token: '', sheet: '' };
        let IS_PUBLIC_MODE = false;
        let PAYMENT_MODE = 'single'; 
        
        let STATE = { 
            data: [], 
            headers: [], 
            currentEdit: null,
            multiDataCache: {},
            sheetPrices: {}
        };

        // --- HELPER ---
        function getKey(obj, candidates) {
            if (!obj) return null;
            const keys = Object.keys(obj);
            for (let c of candidates) {
                const found = keys.find(k => k.toLowerCase() === c.toLowerCase());
                if (found) return found;
            }
            return null;
        }

        // --- INIT & AUTH ---
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            let publicSheet = null;
            if(params.has('sheet')) publicSheet = params.get('sheet');
            else {
                for (const [key, value] of params.entries()) {
                    if(key !== 'nocache' && !value) { publicSheet = key; break; }
                }
            }

            if (publicSheet) {
                // Public Mode Setup
                IS_PUBLIC_MODE = true;
                APP_CONFIG.url = window.location.href.split('?')[0]; 
                APP_CONFIG.sheet = publicSheet;
                APP_CONFIG.token = ''; 
                
                // UI Handling: Show Dashboard directly
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-content').style.display = 'block';
                // Note: Public mode doesn't show header/nav based on previous logic usually
                
                const headerTitle = document.querySelector('#header-title');
                if(headerTitle) headerTitle.innerText = APP_CONFIG.sheet + " (Lihat Saja)";
                fetchData(); 
            } else {
                // Admin Mode Setup
                const stored = JSON.parse(localStorage.getItem('gas_dashboard_config'));
                if (stored && stored.url && stored.token && stored.sheet) {
                    // Auto Login Logic
                    APP_CONFIG = stored;
                    document.getElementById('app-url').value = stored.url || '';
                    document.getElementById('api-token').value = stored.token || '';
                    document.getElementById('sheet-name').value = stored.sheet || '';
                    
                    // Panggil Login Otomatis
                    doLogin(true);
                } else {
                    // Tampilkan form login siap diisi
                    document.getElementById('login-view').classList.remove('hidden');
                }
            }
        });

        async function doLogin(silent = false) {
            APP_CONFIG.url = document.getElementById('app-url').value.trim();
            APP_CONFIG.token = document.getElementById('api-token').value.trim();
            APP_CONFIG.sheet = document.getElementById('sheet-name').value.trim();

            if (!APP_CONFIG.url || !APP_CONFIG.token || !APP_CONFIG.sheet) {
                if(!silent) showToast("Mohon isi data login lengkap");
                return resetToLogin();
            }
            
            if (APP_CONFIG.sheet.toLowerCase() === 'bendahara') PAYMENT_MODE = 'multi';
            else PAYMENT_MODE = 'single';

            localStorage.setItem('gas_dashboard_config', JSON.stringify(APP_CONFIG));
            toggleLoading(true);
            try {
                await fetchData();
                
                // Success Login: Show Dashboard, Hide Login
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-content').style.display = 'block';
                document.getElementById('main-nav').style.display = 'flex';
                document.getElementById('main-header').classList.remove('hidden');
                
                const headerTitle = document.querySelector('#header-title');
                const riwayatTitle = document.getElementById('riwayat-sheet-name');
                let titleText = APP_CONFIG.sheet;
                if (PAYMENT_MODE === 'multi') titleText = "Bendahara (Multi)";
                
                if(headerTitle) headerTitle.innerText = titleText;
                if(riwayatTitle) riwayatTitle.innerText = titleText;
                if (!silent) showToast("Login Berhasil");
            } catch (e) {
                console.error(e);
                if(silent) showToast("Sesi Login Habis. Silakan Login Ulang.");
                else showToast("Error Login: " + e.message);
                
                // Error Login: Reset to Login Screen
                resetToLogin();
            } finally { toggleLoading(false); }
        }

        function resetToLogin() {
            document.getElementById('login-view').classList.remove('hidden');
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('main-nav').style.display = 'none';
            document.getElementById('main-header').classList.add('hidden');
        }

        function handleLogout() { 
            localStorage.removeItem('gas_dashboard_config'); 
            resetToLogin();
            if(IS_PUBLIC_MODE) window.location.href = window.location.href.split('?')[0];
            else {
                // Clear password field for security UX
                document.getElementById('api-token').value = '';
            }
        }

        function shareSheet() {
            const sheetName = APP_CONFIG.sheet;
            window.open("https://la6.my.id/" + sheetName, '_blank');
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            toggleLoading(true);
            try {
                if (PAYMENT_MODE === 'multi') await fetchMultiData();
                else await fetchSingleData();
                
                renderCards(STATE.data);
                updateSummaryCards();
                const currentTab = document.querySelector('.view-section.active').id;
                if(currentTab === 'view-riwayat') fetchRiwayat();
            } catch (e) {
                console.error(e);
                showToast("Gagal mengambil data: " + e.message);
            } finally { toggleLoading(false); }
        }

        async function fetchSingleData() {
            const url = new URL(APP_CONFIG.url);
            url.searchParams.append('sheet', APP_CONFIG.sheet);
            url.searchParams.append('action', 'get-data');
            if (IS_PUBLIC_MODE) url.searchParams.append('mode', 'public');
            else url.searchParams.append('token', APP_CONFIG.token);
            
            const res = await fetch(url.toString());
            const json = await res.json();
            if (!json.success) throw new Error(json.message || "Gagal mengambil data");
            STATE.data = json.data;
            STATE.headers = json.data.length > 0 ? Object.keys(json.data[0]) : [];
        }

        async function fetchMultiData() {
            STATE.multiDataCache = {}; 
            const promises = MULTI_SHEETS.map(async (sheetName) => {
                const url = new URL(APP_CONFIG.url);
                url.searchParams.append('sheet', sheetName);
                url.searchParams.append('action', 'get-data');
                url.searchParams.append('token', APP_CONFIG.token);
                try {
                    const res = await fetch(url.toString());
                    const json = await res.json();
                    if (json.success && json.data) return { sheet: sheetName, data: json.data };
                    return { sheet: sheetName, data: [] };
                } catch (e) {
                    console.warn(`Gagal fetch ${sheetName}`, e);
                    return { sheet: sheetName, data: [] };
                }
            });
            const results = await Promise.all(promises);
            results.forEach(res => { STATE.multiDataCache[res.sheet] = res.data; });

            const mergedMap = new Map();
            results.forEach(res => {
                const sheetData = res.data;
                if (sheetData.length === 0) return;
                sheetData.forEach(row => {
                    const blokKey = getKey(row, ['blok', 'block', 'no', 'no rumah', 'unit', 'nomor']);
                    if (!blokKey) return;
                    const blok = row[blokKey];
                    if (!blok || String(blok).trim() === "") return;
                    const namaKey = getKey(row, ['nama', 'pemilik', 'name', 'warga']);
                    const fotoKey = getKey(row, ['foto', 'gambar', 'image', 'url', 'pic']);
                    const currentNama = namaKey ? row[namaKey] : '-';
                    const currentFoto = fotoKey ? row[fotoKey] : '';

                    if (!mergedMap.has(blok)) {
                        mergedMap.set(blok, { Blok: blok, Nama: currentNama, Foto: currentFoto, _rawData: {} });
                    } else {
                        const existing = mergedMap.get(blok);
                        if (!existing.Nama || existing.Nama === '-') existing.Nama = currentNama;
                        if (!existing.Foto || existing.Foto === '') existing.Foto = currentFoto;
                    }
                    mergedMap.get(blok)._rawData[res.sheet] = row;
                });
            });
            STATE.data = Array.from(mergedMap.values());
            STATE.headers = ['Blok', 'Nama', 'Foto', 'Kurang_Total'];
            if (STATE.data.length === 0) showToast("âš ï¸ Data gabungan kosong.");
        }

        // --- SAVING ---
        async function saveData() {
            if (IS_PUBLIC_MODE) return showToast("âŒ Mode Publik: Tidak bisa mengubah data.");
            if (PAYMENT_MODE === 'multi') await saveMultiData();
            else await saveSingleData();
        }

        async function saveSingleData() {
            const params = { Blok: STATE.currentEdit['Blok'] };
            let totalPembayaran = 0;

            STATE.headers.forEach((h, index) => {
                // Skip Protected Columns (Absen)
                if (PROTECTED_INDICES.includes(index)) return;

                if (!FORMULA_COLS.includes(h) && h !== 'Blok' && !MONTHS.includes(h) && h !== '2025') {
                    const input = document.getElementById(`field-${h}`);
                    if (input) params[h] = input.value;
                }
            });

            MONTHS.forEach(m => {
                const input = document.getElementById(`month-input-${m}`);
                if (input) {
                    const val = parseFloat(input.value) || 0;
                    params[m] = val;
                    totalPembayaran += val;
                }
            });
            logAndSend(APP_CONFIG.sheet, params, totalPembayaran);
        }

        async function saveMultiData() {
            const blok = STATE.currentEdit['Blok'];
            const promises = [];
            MULTI_SHEETS.forEach(sheetName => {
                const params = { Blok: blok };
                let totalSheet = 0;
                MONTHS.forEach(m => {
                    const inputId = `month-input-${m}-${sheetName}`;
                    const input = document.getElementById(inputId);
                    if (input) {
                        const val = parseFloat(input.value) || 0;
                        params[m] = val;
                        totalSheet += val;
                    }
                });
                promises.push(fetchAndLog(sheetName, params, totalSheet));
            });
            try {
                await Promise.all(promises);
                showToast("âœ… Pembayaran Berhasil Disimpan!");
                closeModal('edit-modal');
                fetchData();
            } catch (e) { showToast("âŒ Gagal simpan sebagian data."); }
        }

        async function fetchAndLog(sheetTarget, params, amount) {
            const url = new URL(APP_CONFIG.url);
            url.searchParams.append('token', APP_CONFIG.token);
            url.searchParams.append('sheet', sheetTarget);
            url.searchParams.append('action', 'update');
            Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));
            
            const namaWarga = document.getElementById('modal-nama').innerText;
            const tanggalHariIni = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            params['sheet_log'] = 'Riwayat';     
            params['Tanggal'] = tanggalHariIni; 
            params['Pesan'] = `Admin Bayar ${sheetTarget} (${namaWarga}): ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(amount)}`;
            for (const [key, value] of Object.entries(params)) {
                if (['sheet_log', 'Tanggal', 'Pesan'].includes(key)) url.searchParams.append(key, value);
            }
            const res = await fetch(url.toString());
            const json = await res.json();
            if (!json.success) throw new Error(json.message);
        }

        async function logAndSend(sheetTarget, params, amount) {
            toggleLoading(true);
            try {
                const url = new URL(APP_CONFIG.url);
                url.searchParams.append('token', APP_CONFIG.token);
                url.searchParams.append('sheet', sheetTarget);
                url.searchParams.append('action', 'update');
                Object.keys(params).forEach(k => url.searchParams.append(k, params[k]));

                const namaWarga = document.getElementById('modal-nama').innerText;
                const tanggalHariIni = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                params['sheet_log'] = 'Riwayat';     
                params['Tanggal'] = tanggalHariIni; 
                params['Pesan'] = `${namaWarga} melakukan pembayaran ${sheetTarget} sebesar ${new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(amount)}`;
                for (const [key, value] of Object.entries(params)) {
                    if (['sheet_log', 'Tanggal', 'Pesan'].includes(key)) url.searchParams.append(key, value);
                }
                const res = await fetch(url.toString());
                const json = await res.json();
                if (!json.success) throw new Error(json.message);
                showToast("âœ… Pembayaran Berhasil!");
                closeModal('edit-modal');
                fetchData();
            } catch (e) { showToast("âŒ Gagal simpan: " + e.message); } 
            finally { toggleLoading(false); }
        }

        async function updateTokenAction() {
            if (IS_PUBLIC_MODE) return showToast("âŒ Tidak bisa ubah password di mode publik.");
            const oldToken = document.getElementById('old-token').value.trim();
            const newToken = document.getElementById('new-token').value.trim();
            const sheetTarget = document.getElementById('set-sheet-target').value; 
            if (!oldToken || !newToken) return showToast("Isi token lama dan baru wajib");
            if (oldToken !== APP_CONFIG.token) return showToast("Token lama salah");

            toggleLoading(true);
            try {
                const url = new URL(APP_CONFIG.url);
                url.searchParams.append('token', APP_CONFIG.token); 
                url.searchParams.append('sheet_target', sheetTarget);
                url.searchParams.append('new_token', newToken);
                url.searchParams.append('action', 'update-token');
                const res = await fetch(url.toString());
                const json = await res.json();
                if (json.success) {
                    showToast("âœ… Token Berhasil Diupdate! Silakan Refresh.");
                    document.getElementById('settings-form').reset();
                    closeModal('settings-modal');
                } else { showToast("Gagal: " + json.message); }
            } catch (e) { showToast("Error: " + e.message); } 
            finally { toggleLoading(false); }
        }

        function getSettings() {
            let index = 12; let price = 0;
            let sourceData = STATE.data;
            
            if (PAYMENT_MODE === 'multi') {
                STATE.sheetPrices = {}; 
                MULTI_SHEETS.forEach(sheetName => {
                    let specificPrice = 0;
                    const sheetData = STATE.multiDataCache[sheetName] || [];
                    if (sheetData.length > 3) {
                        const rowT5 = sheetData[3];
                        let foundPrice = 0;
                        if (rowT5 && rowT5['Bulan_Aktif'] && !isNaN(rowT5['Bulan_Aktif'])) {
                            foundPrice = parseFloat(rowT5['Bulan_Aktif']);
                        } else {
                            for(let i=0; i<sheetData.length; i++) {
                                if (sheetData[i]['Bulan_Aktif'] && !isNaN(sheetData[i]['Bulan_Aktif'])) {
                                    foundPrice = parseFloat(sheetData[i]['Bulan_Aktif']); break;
                                }
                            }
                        }
                        specificPrice = foundPrice;
                    }
                    STATE.sheetPrices[sheetName] = specificPrice;
                });
                sourceData = STATE.multiDataCache["Kas"] || [];
            } else {
                // --- SINGLE MODE UPDATE ---
                // Ambil Price dari Row 5 (Array Index 3) di kolom Bulan_Aktif (di bawah tulisan PerAbsen)
                if (sourceData.length > 3) {
                    const priceRow = sourceData[3];
                    let priceVal = priceRow['Bulan_Aktif'];
                    if (!priceVal) priceVal = priceRow['PerAbsen'];

                    if (priceVal && !isNaN(parseFloat(priceVal))) {
                        price = parseFloat(priceVal);
                    }
                }
            }

            // Cari Active Month (Index) - Looping baris (umumnya baris setting awal)
            sourceData.forEach(row => {
                const val = row['Bulan_Aktif'];
                if (val !== undefined && val !== '' && val !== null) {
                    const numVal = parseFloat(val);
                    if (numVal >=1 && numVal <= 12) index = numVal;
                    // Hapus logika update price di sini agar tidak bentrok dengan harga baris 5
                }
            });
            return { index, price };
        }

        // --- LOCK LOGIC ---
        function toggleLock(btn) {
            event.preventDefault(); 
            event.stopPropagation();

            const row = btn.closest('.month-row') || btn.closest('.month-row-multi');
            if(!row) return;
            
            // Logic Lock untuk Multi Mode: Kunci semua input di dalam row ini
            if (PAYMENT_MODE === 'multi') {
                const inputs = row.querySelectorAll('.multi-input-field');
                const checkboxes = row.querySelectorAll('.mini-checkbox');
                const isLocked = btn.classList.contains('locked');

                if (isLocked) {
                    btn.classList.remove('locked');
                    btn.innerHTML = document.getElementById('icon-unlock').outerHTML;
                    inputs.forEach(i => {
                        // Enable hanya jika checkbox tidak checked
                        const wrapper = i.closest('.multi-cat-box');
                        const cb = wrapper.querySelector('.mini-checkbox');
                        if(!cb.checked) i.disabled = false;
                    });
                    checkboxes.forEach(cb => cb.disabled = false);
                } else {
                    btn.classList.add('locked');
                    btn.innerHTML = document.getElementById('icon-lock').outerHTML;
                    inputs.forEach(i => i.disabled = true);
                    checkboxes.forEach(cb => cb.disabled = true);
                }
            } else {
                // Logic Lock Single Mode
                const inputs = row.querySelectorAll('input:not([type="hidden"])');
                const isLocked = btn.classList.contains('locked');

                if (isLocked) {
                    btn.classList.remove('locked');
                    btn.innerHTML = document.getElementById('icon-unlock').outerHTML;
                    
                    const checkboxes = row.querySelectorAll('input[type="checkbox"]');
                    if(checkboxes.length > 0 && checkboxes[0].checked) {
                        row.querySelectorAll('input[type="number"]').forEach(i => i.disabled = true);
                    } else {
                        inputs.forEach(i => i.disabled = false);
                    }
                } else {
                    btn.classList.add('locked');
                    btn.innerHTML = document.getElementById('icon-lock').outerHTML;
                    inputs.forEach(i => i.disabled = true);
                }
            }
        }

        // --- RENDERING ---
        function renderRekap() {
            const container = document.getElementById('rekap-container');
            container.innerHTML = '';
            if (PAYMENT_MODE === 'single') {
                const settings = getSettings();
                const activeMonthLimit = settings.index; 
                let grandTotal = 0;

                MONTHS.forEach((m, index) => {
                    if (index >= activeMonthLimit) return;

                    // Hitung total per bulan
                    let monthTotal = 0;
                    STATE.data.forEach(row => {
                        monthTotal += parseFloat(row[m]) || 0;
                    });
                    grandTotal += monthTotal;

                    const fmtTotal = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(monthTotal);

                    // PERUBAHAN: Gunakan List Item (Div) alih-alih Tabel
                    const div = document.createElement('div');
                    div.className = 'rekap-row-item';
                    div.innerHTML = `<span class="rekap-row-label">${m}</span><span class="rekap-row-value">${fmtTotal}</span>`;
                    container.appendChild(div);
                });

                // Baris Total Akhir
                const fmtGrand = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(grandTotal);
                const grandDiv = document.createElement('div');
                grandDiv.className = 'rekap-row-item grand-total-row';
                grandDiv.innerHTML = `<span class="rekap-row-label">Total Akhir</span><span class="rekap-row-value">${fmtGrand}</span>`;
                container.appendChild(grandDiv);
                return;
            }
            
            // MULTI MODE: TAMPILKAN ACCORDION (TIDAK DIUBAH)
            const grandTotals = {}; MONTHS.forEach(m => grandTotals[m] = 0);
            const sheetTotals = {}; MULTI_SHEETS.forEach(s => { sheetTotals[s] = {}; MONTHS.forEach(m => sheetTotals[s][m] = 0); });
            STATE.data.forEach(row => {
                MONTHS.forEach(m => {
                    MULTI_SHEETS.forEach(sheet => {
                        const r = row._rawData[sheet];
                        if (r) {
                            const val = parseFloat(r[m]) || 0;
                            sheetTotals[sheet][m] += val;
                            grandTotals[m] += val;
                        }
                    });
                });
            });
            MONTHS.forEach(m => {
                const total = grandTotals[m];
                const fmtTotal = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(total);
                const itemDiv = document.createElement('div'); itemDiv.className = 'rekap-item';
                const headerDiv = document.createElement('div');
                headerDiv.className = 'rekap-header';
                headerDiv.onclick = function() { toggleRekap(this); };
                headerDiv.innerHTML = `<span class="rekap-month">${m}</span><div style="display:flex; align-items:center; gap:10px;"><span class="rekap-total">${fmtTotal}</span><span class="rekap-chevron">â–¼</span></div>`;
                const detailsDiv = document.createElement('div');
                detailsDiv.className = 'rekap-details';
                MULTI_SHEETS.forEach(sheet => {
                    const sheetTotal = sheetTotals[sheet][m];
                    const fmtSheet = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(sheetTotal);
                    const subDiv = document.createElement('div');
                    let cssClass = 'rekap-sub-item';
                    if(sheet === 'Kas') cssClass += ' sub-kas';
                    if(sheet === 'Sampah') cssClass += ' sub-sampah';
                    if(sheet === 'Konsumsi') cssClass += ' sub-konsumsi';
                    if(sheet === 'Arisan') cssClass += ' sub-arisan';
                    subDiv.className = cssClass;
                    subDiv.innerHTML = `<span>${sheet}</span><span class="rekap-sub-val">${fmtSheet}</span>`;
                    detailsDiv.appendChild(subDiv);
                });
                itemDiv.appendChild(headerDiv);
                itemDiv.appendChild(detailsDiv);
                container.appendChild(itemDiv);
            });
        }

        function toggleRekap(headerElement) {
            document.querySelectorAll('.rekap-details').forEach(el => el.classList.remove('show'));
            document.querySelectorAll('.rekap-item').forEach(el => el.classList.remove('expanded'));
            const details = headerElement.nextElementSibling;
            const item = headerElement.parentElement;
            details.classList.add('show');
            item.classList.add('expanded');
        }

        async function fetchRiwayat() {
            const container = document.getElementById('riwayat-container');
            container.innerHTML = '<div style="text-align:center; padding:2rem;"><div class="spinner" style="margin:0 auto;"></div><p style="margin-top:10px;">Memuat Data...</p></div>';

            try {
                const url = new URL(APP_CONFIG.url);
                url.searchParams.set('nocache', new Date().getTime());

                if (!IS_PUBLIC_MODE) url.searchParams.append('token', APP_CONFIG.token); 
                else url.searchParams.append('mode', 'public');
                url.searchParams.append('sheet', 'Riwayat'); 
                url.searchParams.append('action', 'get-data');
                
                const res = await fetch(url.toString());
                const json = await res.json();
                
                if (!json.success) { 
                    container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--danger);"><p>Gagal memuat Riwayat.<br>Error: ${json.message}</p></div>`; 
                    return; 
                }

                const data = json.data;
                if (data.length === 0) { 
                    container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--secondary);"><p>Belum ada riwayat.</p></div>`; 
                    return; 
                }

                const sheetName = APP_CONFIG.sheet;
                const filteredData = data.filter(row => {
                    if (!row.Pesan) return false;
                    if (row.Pesan.toLowerCase().includes("password")) return false;
                    if (PAYMENT_MODE === 'multi') return MULTI_SHEETS.some(cat => row.Pesan.includes(cat));
                    else return row.Pesan.includes(sheetName);
                }).reverse();
                
                setTimeout(() => {
                    container.innerHTML = '';
                    
                    filteredData.forEach(row => {
                        let dateDisplay = row.Tanggal || row.Timestamp || "-";
                        if (dateDisplay instanceof Date) dateDisplay = dateDisplay.toLocaleDateString('id-ID');
                        const div = document.createElement('div');
                        div.className = 'riwayat-item';
                        div.innerHTML = `<div class="riwayat-date">${dateDisplay}</div><div class="riwayat-msg">${row.Pesan}</div>`;
                        container.appendChild(div);
                    });
                }, 50);
            } catch (e) { 
                container.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--danger);"><p>Error: ${e.message}</p></div>`; 
            }
        }

        function switchTab(tabName, el) {
            if (IS_PUBLIC_MODE) return;
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            if(el) el.classList.add('active');
            const views = document.querySelectorAll('.view-section');
            views.forEach(v => v.classList.remove('active'));
            if (tabName === 'pembayaran') document.getElementById('view-pembayaran').classList.add('active');
            else if (tabName === 'rekap') { document.getElementById('view-rekap').classList.add('active'); renderRekap(); }
            else if (tabName === 'riwayat') { document.getElementById('view-riwayat').classList.add('active'); fetchRiwayat(); }
            else if (tabName === 'settings') openSettingsModal();
        }

        function renderCards(data) {
            const container = document.getElementById('card-container');
            container.innerHTML = '';
            if (!data || data.length === 0) return document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('empty-state').classList.add('hidden');

            const idxKurang = findIdx(['kurang', 'sisa', 'deficit']);
            const idxNama = findIdx(['nama', 'pemilik', 'name']);
            const idxImg = findIdx(['foto', 'gambar', 'image', 'url', 'pic']);

            data.forEach((row, i) => {
                const nama = (PAYMENT_MODE === 'multi') ? row['Nama'] : getVal(row, idxNama);
                if (!nama || nama.trim() === "" || nama.toLowerCase() === '-') return;
                const blok = row['Blok'];
                const imgUrl = (PAYMENT_MODE === 'multi') ? row['Foto'] : getVal(row, idxImg);
                const avatarSrc = (imgUrl && imgUrl.startsWith('http')) ? imgUrl : DEFAULT_IMG;
                let kurang = 0;
                if (PAYMENT_MODE === 'multi') {
                    MULTI_SHEETS.forEach(sheet => {
                        const r = row._rawData[sheet];
                        if (r) { const kurangKey = getKey(r, ['kurang', 'sisa', 'deficit']); if (kurangKey) kurang += parseFloat(r[kurangKey]) || 0; }
                    });
                } else { kurang = parseFloat(getVal(row, idxKurang)) || 0; }
                
                let badgeHTML = '';
                
                // PERUBAHAN LOGIKA BADGE LUNAS
                if (kurang <= 0) {
                    const fmtOverpay = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(Math.abs(kurang));
                    
                    // Badge Nominal (Hanya muncul jika ada overpay/kurang < 0)
                    const overpayBadge = (kurang < 0) ? `<div class="lunas-amount-tag">+${fmtOverpay}</div>` : '';
                    
                    // Badge Label (Selalu muncul)
                    const labelBadge = `<div class="lunas-button-tag">âœ… Lunas</div>`;
                    
                    // Wrapper
                    badgeHTML = `<div class="lunas-status-container">${overpayBadge}${labelBadge}</div>`;
                } else {
                    const fmtKurang = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(kurang);
                    if (IS_PUBLIC_MODE) badgeHTML = `<div class="badge kurang-badge readonly">${fmtKurang}</div>`;
                    else badgeHTML = `<div class="badge kurang-badge">${fmtKurang}</div>`;
                }
                
                const div = document.createElement('div');
                div.className = 'warga-card';
                if (!IS_PUBLIC_MODE) { div.onclick = function() { openEdit(blok); }; div.style.cursor = "pointer"; }
                div.innerHTML = `<img src="${avatarSrc}" class="avatar" onerror="this.src='${DEFAULT_IMG}'"><div class="info"><div class="info-name" title="${nama}">${nama}</div><div class="info-blok">Rumah Blok ${blok}</div></div>${badgeHTML}`;
                container.appendChild(div);
            });
        }

        function updateSummaryCards() {
            let totalSudahBayar = 0; let totalKurang = 0;
            const sourceData = STATE.data;
            if (sourceData.length > 0) {
                if (PAYMENT_MODE === 'multi') {
                    sourceData.forEach(row => {
                        // PERUBAHAN: Cek apakah kolom Nama ada
                        const nama = row['Nama'];
                        if (!nama || nama.trim() === "" || nama.toLowerCase() === '-') return;

                        MULTI_SHEETS.forEach(sheet => {
                            const r = row._rawData[sheet];
                            if (r) {
                                const bayarKey = getKey(r, ['sudah_bayar', 'bayar', 'terbayar']);
                                const kurangKey = getKey(r, ['kurang', 'sisa', 'deficit']);
                                if (bayarKey) totalSudahBayar += parseFloat(r[bayarKey]) || 0;
                                if (kurangKey) totalKurang += parseFloat(r[kurangKey]) || 0;
                            }
                        });
                    });
                } else {
                    const headerKeys = STATE.headers;
                    const idxBayar = headerKeys.findIndex(h => h.toLowerCase().includes('sudah_bayar'));
                    const idxKurang = headerKeys.findIndex(h => h.toLowerCase().includes('kurang'));
                    const idxNama = findIdx(['nama', 'pemilik', 'name']);

                    sourceData.forEach(row => {
                        // PERUBAHAN: Cek apakah kolom Nama ada
                        const nama = getVal(row, idxNama);
                        if (!nama || nama.trim() === "" || nama.toLowerCase() === '-') return;

                        if (idxBayar !== -1) totalSudahBayar += parseFloat(row[headerKeys[idxBayar]]) || 0;
                        if (idxKurang !== -1) totalKurang += parseFloat(row[headerKeys[idxKurang]]) || 0;
                    });
                }
            }
            const fmtBayar = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalSudahBayar);
            const fmtTunggakan = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(totalKurang);
            const statPemasukan = document.getElementById('stat-pemasukan');
            if(statPemasukan) statPemasukan.innerText = fmtBayar;
            const statTunggakan = document.getElementById('stat-tunggakan');
            if(statTunggakan) statTunggakan.innerText = fmtTunggakan;
        }

        function openEdit(blokId) {
            if (IS_PUBLIC_MODE) return; 
            let row;
            if (PAYMENT_MODE === 'multi') row = STATE.data.find(r => r['Blok'] == blokId);
            else row = STATE.data.find(r => r['Blok'] == blokId);
            if (!row) return;
            STATE.currentEdit = row;

            const idxNama = findIdx(['nama', 'pemilik', 'name']);
            const idxImg = findIdx(['foto', 'gambar', 'image', 'url', 'pic']);
            const idxKurang = findIdx(['kurang', 'sisa', 'deficit']);
            const nama = (PAYMENT_MODE === 'multi') ? row['Nama'] : getVal(row, idxNama);
            const imgUrl = (PAYMENT_MODE === 'multi') ? row['Foto'] : getVal(row, idxImg);
            const avatarSrc = (imgUrl && imgUrl.startsWith('http')) ? imgUrl : DEFAULT_IMG;
            let valKurang = 0;
            if (PAYMENT_MODE === 'multi') {
                MULTI_SHEETS.forEach(sheet => {
                    const r = row._rawData[sheet];
                    if (r) { const kurangKey = getKey(r, ['kurang', 'sisa', 'deficit']); if (kurangKey) valKurang += parseFloat(r[kurangKey]) || 0; }
                });
            } else { valKurang = parseFloat(getVal(row, idxKurang)) || 0; }
            const fmtKurang = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(valKurang);

            const modalAvatar = document.getElementById('modal-avatar');
            const modalNama = document.getElementById('modal-nama');
            const modalBlok = document.getElementById('modal-blok');
            const btnKurang = document.getElementById('btn-kurang-modal');
            if(modalAvatar) modalAvatar.src = avatarSrc;
            if(modalAvatar) modalAvatar.onerror = function() { this.src = DEFAULT_IMG; };
            if(modalNama) modalNama.innerText = nama;
            if(modalBlok) modalBlok.innerText = blokId;
            if(btnKurang) {
                btnKurang.innerText = `Kurang: ${fmtKurang}`;
                btnKurang.dataset.val = valKurang; 
                if(valKurang <= 0) btnKurang.style.display = 'none';
                else btnKurang.style.display = 'inline-block';
            }

            const generalContainer = document.getElementById('general-fields');
            const monthlyContainer = document.getElementById('monthly-fields');
            generalContainer.innerHTML = '';
            monthlyContainer.innerHTML = '';

            const settings = getSettings();
            const activeMonthLimit = settings.index; 

            if (PAYMENT_MODE === 'single') {
                const globalPrice = settings.price; 
                
                STATE.headers.forEach((h, index) => {
                    if (MONTHS.includes(h) || FORMULA_COLS.includes(h)) return; 
                    if (h === 'Blok' || h === 'Nama' || h === 'nama' || h === 'Foto') return;
                    
                    if (PROTECTED_INDICES.includes(index)) {
                        const val = row[h] !== undefined ? row[h] : '';
                        const div = document.createElement('div');
                        div.className = 'protected-field';
                        div.innerHTML = `
                            <label class="form-label">${h} (Aman)</label>
                            <div class="readonly-value">${val}</div>
                        `;
                        generalContainer.appendChild(div);
                        return;
                    }

                    if (h === '2025') {
                         const val = row[h] || 0;
                         const fmtVal = new Intl.NumberFormat('id-ID').format(val);
                         const div = document.createElement('div');
                         div.className = 'form-group';
                         div.innerHTML = `<div class="note-2025">Catatan: ${h} tunggakan <span>${fmtVal}</span></div>`;
                         generalContainer.appendChild(div);
                         return; 
                    }
                    const val = row[h] !== undefined ? row[h] : '';
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `<label class="form-label">${h}</label><input type="text" id="field-${h}" class="form-input" value="${val}">`;
                    generalContainer.appendChild(div);
                });

                MONTHS.forEach((month, index) => {
                    if (index >= activeMonthLimit) return;
                    const monthVal = parseFloat(row[month]) || 0;
                    const isChecked = (monthVal === globalPrice);
                    const isLocked = isChecked;

                    const div = document.createElement('div');
                    div.className = `month-row`;
                    
                    let iconHtml = document.getElementById('icon-unlock').outerHTML;
                    let lockClass = '';
                    if(isLocked) { iconHtml = document.getElementById('icon-lock').outerHTML; lockClass = 'locked'; }

                    let absenHtml = '';
                    if (ABSEN_MAP[month] !== undefined) {
                        const absenIndex = ABSEN_MAP[month];
                        const absenVal = row[STATE.headers[absenIndex]] || 0;
                        if (absenVal && absenVal !== 0) {
                            absenHtml = `<span class="absen-badge">${absenVal}x</span>`;
                        }
                    }

                    div.innerHTML = `
                        <div class="month-header">
                            <div class="title-group">
                                <button class="btn-lock ${lockClass}" onclick="toggleLock(this)">${iconHtml}</button>
                                <label class="month-label">${month}</label>
                            </div>
                            <span class="month-total-display" style="font-size: 0.8rem; color: #666; font-weight:600;">Total: ${new Intl.NumberFormat('id-ID').format(monthVal)}</span>
                        </div>
                        <div class="month-controls">
                            <input type="checkbox" id="check-${month}" class="month-checkbox" onchange="toggleMonthMode('${month}', this)" ${isChecked ? 'checked' : ''} ${isLocked ? 'disabled' : ''}>
                            <div class="input-wrapper">
                                <input type="number" id="month-input-${month}" class="month-input" value="${monthVal}" oninput="handleManualInput('${month}', this)" ${isChecked || isLocked ? 'disabled' : ''}>
                                ${absenHtml}
                            </div>
                        </div>
                    `;
                    monthlyContainer.appendChild(div);
                });

            } else {
                // RENDER MULTI MODE (UPDATED LAYOUT)
                MONTHS.forEach((month, index) => {
                    if (index >= activeMonthLimit) return;
                    let monthTotal = 0;
                    let allPaid = true;
                    
                    MULTI_SHEETS.forEach(sheet => {
                        const r = row._rawData[sheet];
                        const val = r ? parseFloat(r[month]) || 0 : 0;
                        const standardPrice = STATE.sheetPrices[sheet] || 0;
                        monthTotal += val;
                        if (val !== standardPrice) allPaid = false;
                    });

                    const isLocked = false; 
                    const div = document.createElement('div');
                    div.className = `month-row-multi`; 
                    let iconHtml = document.getElementById('icon-unlock').outerHTML;

                    div.innerHTML = `
                        <div class="month-header">
                            <div class="title-group">
                                <button class="btn-lock" onclick="toggleLock(this)">${iconHtml}</button>
                                <label class="month-label" style="width:auto;">${month}</label>
                            </div>
                            <div style="font-size:0.75rem; color:var(--secondary); font-weight:600;">Total: ${new Intl.NumberFormat('id-ID').format(monthTotal)}</div>
                        </div>
                        <div class="month-multi-inputs" id="inputs-${month}"></div>
                    `;
                    monthlyContainer.appendChild(div);

                    const inputsContainer = div.querySelector(`#inputs-${month}`);
                    MULTI_SHEETS.forEach(sheet => {
                        const r = row._rawData[sheet];
                        const val = r ? parseFloat(r[month]) || 0 : 0;
                        const standardPrice = STATE.sheetPrices[sheet] || 0;
                        const isChecked = (val === standardPrice);
                        
                        // --- UPDATED HTML STRUCTURE ---
                        const group = document.createElement('div');
                        group.className = 'multi-cat-box'; 
                        group.innerHTML = `
                            <div class="cat-header">
                                <input type="checkbox" id="check-${month}-${sheet}" class="mini-checkbox" onchange="toggleMultiSheetMode('${month}', '${sheet}', this)" ${isChecked ? 'checked' : ''}>
                                <label class="cat-label">${sheet}</label>
                            </div>
                            <div class="cat-input-box">
                                <input type="number" id="month-input-${month}-${sheet}" class="multi-input-field" value="${val}" 
                                oninput="handleMultiManualInput('${month}', '${sheet}', this)" ${isChecked ? 'disabled' : ''}>
                            </div>
                        `;
                        inputsContainer.appendChild(group);
                    });
                });
            }

            const overlay = document.getElementById('edit-modal');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
        }

        function autoFillKurang() {
            if (!STATE.currentEdit) return;
            const btnKurang = document.getElementById('btn-kurang-modal');
            const valKurang = parseFloat(btnKurang.dataset.val) || 0;
            if (valKurang <= 0) return showToast("Tidak ada tagihan (Kurang).");

            let targetMonthDiv = null;
            const monthDivs = document.querySelectorAll(PAYMENT_MODE === 'multi' ? '.month-row-multi' : '.month-row');
            for (let div of monthDivs) {
                const lockBtn = div.querySelector('.btn-lock');
                if(lockBtn && lockBtn.classList.contains('locked')) continue;
                const cb = div.querySelector('input[type="checkbox"]');
                if (cb && !cb.checked) {
                    targetMonthDiv = div;
                    break;
                }
            }

            if (!targetMonthDiv) return showToast("Semua bulan sudah terisi penuh atau terkunci.");

            if (PAYMENT_MODE === 'single') {
                const globalPrice = getSettings().price;
                const input = targetMonthDiv.querySelector('.month-input');
                if (input) {
                    input.value = valKurang;
                    input.dispatchEvent(new Event('input'));
                }
            } else {
                let sisa = valKurang;
                MULTI_SHEETS.forEach((sheet) => {
                    const input = document.getElementById(`month-input-${getMonthFromDiv(targetMonthDiv)}-${sheet}`);
                    if (!input) return;
                    const standardPrice = STATE.sheetPrices[sheet] || 0;
                    if (document.getElementById(`check-${getMonthFromDiv(targetMonthDiv)}-${sheet}`).checked) return;

                    if (sisa >= standardPrice) {
                        input.value = standardPrice;
                        sisa -= standardPrice;
                    } else if (sisa > 0) {
                        input.value = sisa;
                        sisa = 0;
                    } else {
                        input.value = 0;
                    }
                    input.dispatchEvent(new Event('input'));
                });
                checkMultiMonthStatus(getMonthFromDiv(targetMonthDiv));
            }
            showToast("Nilai Kurang dimasukkan ke input.");
        }

        function getMonthFromDiv(div) {
            const label = div.querySelector('.month-label');
            return label ? label.innerText : '';
        }

        function toggleMonthMode(month, checkbox) {
            const row = checkbox.closest('.month-row');
            const lockBtn = row.querySelector('.btn-lock');
            if(lockBtn && lockBtn.classList.contains('locked')) return;

            const input = document.getElementById(`month-input-${month}`);
            const rowDiv = checkbox.closest('.month-row');
            const globalPrice = getSettings().price;

            if (checkbox.checked) {
                input.value = globalPrice;
                input.disabled = true;
                rowDiv.classList.add('active-month');
            } else {
                input.value = 0;
                input.disabled = false;
                rowDiv.classList.remove('active-month');
                input.focus();
            }
            checkSingleMonthTotal(month);
        }

        function handleManualInput(month, input) {
            const row = input.closest('.month-row');
            const lockBtn = row.querySelector('.btn-lock');
            if(lockBtn && lockBtn.classList.contains('locked')) {
                input.value = parseFloat(input.getAttribute('value') || 0); 
                return;
            }

            const rowDiv = input.closest('.month-row');
            const checkbox = document.getElementById(`check-${month}`);
            if (input.disabled) return;

            const globalPrice = getSettings().price;
            const currentVal = parseFloat(input.value) || 0;

            if (currentVal === globalPrice) {
                checkbox.checked = true;
                input.disabled = true;
                rowDiv.classList.add('active-month');
            } else {
                checkbox.checked = false;
                input.disabled = false;
                rowDiv.classList.remove('active-month');
            }
            checkSingleMonthTotal(month);
        }

        function checkSingleMonthTotal(month) {
            const input = document.getElementById(`month-input-${month}`);
            if(!input) return;
            const val = parseFloat(input.value) || 0;
            const row = input.closest('.month-row');
            const totalDisplay = row.querySelector('.month-total-display');
            if(totalDisplay) totalDisplay.innerText = "Total: " + new Intl.NumberFormat('id-ID').format(val);
        }

        function toggleMultiSheetMode(month, sheetName, checkbox) {
            const row = checkbox.closest('.month-row-multi');
            const lockBtn = row.querySelector('.btn-lock');
            if(lockBtn && lockBtn.classList.contains('locked')) return;

            const input = document.getElementById(`month-input-${month}-${sheetName}`);
            const sheetPrice = STATE.sheetPrices[sheetName] || 0;
            
            if (checkbox.checked) {
                input.value = sheetPrice;
                input.disabled = true;
            } else {
                input.value = 0;
                input.disabled = false;
                input.focus();
            }
            checkMultiMonthTotal(month);
        }

        function handleMultiManualInput(month, sheetName, input) {
            const row = input.closest('.month-row-multi');
            const lockBtn = row.querySelector('.btn-lock');
            if(lockBtn && lockBtn.classList.contains('locked')) {
                input.value = parseFloat(input.getAttribute('value') || 0); // Revert
                return;
            }

            const checkbox = document.getElementById(`check-${month}-${sheetName}`);
            const sheetPrice = STATE.sheetPrices[sheetName] || 0;
            const currentVal = parseFloat(input.value) || 0;

            if (currentVal === sheetPrice) {
                checkbox.checked = true;
                input.disabled = true;
            } else {
                checkbox.checked = false;
                input.disabled = false;
            }
            checkMultiMonthTotal(month);
        }

        function checkMultiMonthTotal(month) {
            const rows = document.querySelectorAll('.month-row-multi');
            let targetRow;
            rows.forEach(r => {
                if (r.querySelector('.month-label').innerText === month) targetRow = r;
            });
            if(targetRow) {
                // Ambil semua input di dalam .month-multi-inputs
                const inputs = targetRow.querySelectorAll('.multi-input-field');
                let total = 0;
                inputs.forEach(i => total += parseFloat(i.value) || 0);
                const totalDiv = targetRow.querySelector('.month-header div:last-child');
                if(totalDiv) totalDiv.innerText = "Total: " + new Intl.NumberFormat('id-ID').format(total);
            }
        }
        
        function checkMultiMonthStatus(month) { }
        
        function closeModal(modalId) {
            const overlay = document.getElementById(modalId);
            overlay.classList.remove('active');
            setTimeout(() => overlay.style.display = 'none', 300);
        }

        function openSettingsModal() {
            if (IS_PUBLIC_MODE) return;
            if (APP_CONFIG.sheet === 'Riwayat') { showToast("âš ï¸ Sheet Riwayat bersifat Publik, password tidak bisa diganti."); return; }
            document.getElementById('set-sheet-target').value = APP_CONFIG.sheet;
            const overlay = document.getElementById('settings-modal');
            overlay.style.display = 'flex';
            setTimeout(() => overlay.classList.add('active'), 10);
        }

        function filterCards() {
            const term = document.getElementById('search-box').value.toLowerCase();
            const filtered = STATE.data.filter(row => {
                const nama = (PAYMENT_MODE === 'multi') ? row['Nama'] : (row['Nama'] || row['nama']);
                const blok = row['Blok'];
                return String(nama).toLowerCase().includes(term) || String(blok).toLowerCase().includes(term);
            });
            renderCards(filtered);
        }

        function findIdx(keys) { return STATE.headers.findIndex(h => keys.some(k => h.toLowerCase().includes(k))); }
        function getVal(row, idx) { return idx !== -1 ? row[STATE.headers[idx]] : ''; }
        function toggleLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function showToast(msg) { 
            const el = document.createElement('div'); el.className = 'toast'; el.innerText = msg;
            const container = document.getElementById('toast-container');
            container.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(20px)'; setTimeout(() => el.remove(), 300); }, 3000); 
        }
    </script>
</body>
</html>
